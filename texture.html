<!DOCTYPE html>
<head>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<title>Mobile Device Info</title>	<!-- include three.js library -->
	<script src='js/three.js'></script>
	<!-- include jsartookit -->
	<script src="jsartoolkit5/artoolkit.min.js"></script>
	<script src="jsartoolkit5/artoolkit.api.js"></script>
	<!-- include threex.artoolkit -->
	<script src="threex/threex-artoolkitsource.js"></script>
	<script src="threex/threex-artoolkitcontext.js"></script>
	<script src="threex/threex-arbasecontrols.js"></script>
	<script src="threex/threex-armarkercontrols.js"></script>


	<!-- device info -->

	<script src="device.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mobile-detect/1.4.4/mobile-detect.min.js"></script>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport"
		  content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">

	<!-- jquery -->

	<script
			src="https://code.jquery.com/jquery-1.11.1.min.js"
			integrity=""
			crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mobile-detect/1.4.4/mobile-detect.js" integrity="" crossorigin="anonymous"></script>
</head>

<body style='margin : 0px; overflow: hidden; font-family: Monospace;'>

<p id="demo" ></p>
<!--<canvas id="myCanvas" width="200" height="100" style="border:1px solid #d3d3d3;">-->
<!--	Your browser does not support the HTML canvas tag.</canvas>-->
<canvas id="myCanvas" width="2000" height="1000" style="border:1px solid #d3d3d3;">
	Your browser does not support the HTML canvas tag.</canvas>
<!-- 
  Example created by Lee Stemkoski: https://github.com/stemkoski
  Based on the AR.js library and examples created by Jerome Etienne: https://github.com/jeromeetienne/AR.js/
-->

<script>

	$(document).ready(function(){
		writeDeviceInfo();

		//case one
		writeGeoLocation();
		//case one

		// //case two
		// var str = $("#demo").text();
		// convertInfoToImg(str);
		// runThisArJS();    //needs to modify
		// //case two



		function writeDeviceInfo(){
			$("#demo").append("GPU:"+MobileDevice.getGlRenderer()+"\n<br>");
			$("#demo").append("Resolution: "+MobileDevice.getResolution()+"\n<br>");

			//判断数组中是否包含某字符串
			Array.prototype.contains = function(needle) {
				for (i in this) {
					if (this[i].indexOf(needle) > 0)
						return i;
				}
				return -1;
			}

			var device_type = navigator.userAgent;//获取userAgent信息
			// document.write("<h1>" + device_type +"</h1>");//打印到页面
			$("#demo").append( device_type +"\n<br>");


			var md = new MobileDetect(device_type);//初始化mobile-detect
			var os = md.os();//获取系统
			var model = "";
			if (os == "iOS") {//ios系统的处理
				os = md.os() + md.version("iPhone");
				model = md.mobile();
			} else if (os == "AndroidOS") {//Android系统的处理
				os = md.os() + md.version("Android");
				var sss = device_type.split(";");
				var i = sss.contains("Build/");
				if (i > -1) {
					model = sss[i].substring(0, sss[i].indexOf("Build/"));
				}
			}
			// alert(os + "---" + model);//打印系统版本和手机型号
			$("#demo").append("Os version and mobile id: "+os + "---" + model + "\n<br>");

		}
		function writeGeoLocation() {
			if (navigator.geolocation) {
				$("#demo").append("Geolocation is supported. Please wait......\n<br>");
				// x.innerHTML = "Geolocation is supported. Please wait......\n";
				navigator.geolocation.getCurrentPosition(showPosition);
			} else {
				$("#demo").append("Geolocation is not supported by this browser.\n<br>");
				// x.innerHTML = "Geolocation is not supported by this browser.";
			}
		}
		function showPosition(position) {
			$("#demo").append("Begin to print Lai & Lon: \n<br>");
			$("#demo").append("Latitude: " + position.coords.latitude + "\n<br>Longitude: " + position.coords.longitude +"\n");
			// x.innerHTML = "Latitude: " + position.coords.latitude +
			//     "<br>Longitude: " + position.coords.longitude;
			var str = $("#demo").text();
			console.log("Print stringTwo: "+str);


			convertInfoToImg(str);
			runThisArJS();    //needs to modify

		}
	});



	//generate text



    //convert to img
	var img = null;

	function convertInfoToImg(str){
		//split
		var listStr = str.split("\n");
		console.log("After split (stringThree): "+listStr);

		//to image line by line
		var c = document.getElementById("myCanvas");
		var ctx = c.getContext("2d");
		ctx.fillStyle = "yellow";
		ctx.font = "30px Arial";
		var str = $("#demo").text();
		console.log("Print stringOne: "+str);
		for(var i=0;i<listStr.length;i++){
			var x = 10;
			var y = 50+(i*50);
			// var y = 50;

			ctx.fillText(listStr[i],x,y);
		}


		var canvas = document.getElementById("myCanvas");
		img    = canvas.toDataURL("image/png"); //
		// document.write('<img src="'+img+'"/>'); // write
		// document.write('<img hidden id='imageInfo' src="'+img+'"/>'); // write
		document.write('<img hidden id="imageInfo" src="'+img+'"/>'); // write
		console.log("Done!");
	}

	//ar.js
	var scene, camera, renderer, clock, deltaTime, totalTime;

	var arToolkitSource, arToolkitContext;

	var markerRoot1;

	var mesh1;


    function runThisArJS(){
    	console.log("begin to run the ar's camera");
		initialize();
		animate();
	}


	function initialize()
	{
		scene = new THREE.Scene();

		let ambientLight = new THREE.AmbientLight( 0xcccccc, 0.5 );
		scene.add( ambientLight );

		camera = new THREE.Camera();
		scene.add(camera);

		renderer = new THREE.WebGLRenderer({
			antialias : true,
			alpha: true
		});
		renderer.setClearColor(new THREE.Color('lightgrey'), 0)
		renderer.setSize( 64000, 48000 );//
		renderer.domElement.style.position = 'absolute'
		renderer.domElement.style.top = '0px'
		renderer.domElement.style.left = '0px'
		document.body.appendChild( renderer.domElement );

		clock = new THREE.Clock();
		deltaTime = 0;
		totalTime = 0;

		////////////////////////////////////////////////////////////
		// setup arToolkitSource
		////////////////////////////////////////////////////////////

		arToolkitSource = new THREEx.ArToolkitSource({
			sourceType : 'webcam',
		});

		function onResize()
		{
			arToolkitSource.onResize()
			arToolkitSource.copySizeTo(renderer.domElement)
			if ( arToolkitContext.arController !== null )
			{
				arToolkitSource.copySizeTo(arToolkitContext.arController.canvas)
			}
		}

		arToolkitSource.init(function onReady(){
			onResize()
		});

		// handle resize event
		window.addEventListener('resize', function(){
			onResize()
		});

		////////////////////////////////////////////////////////////
		// setup arToolkitContext
		////////////////////////////////////////////////////////////

		// create atToolkitContext
		arToolkitContext = new THREEx.ArToolkitContext({
			cameraParametersUrl: 'data/camera_para.dat',
			detectionMode: 'mono'
		});

		// copy projection matrix to camera when initialization complete
		arToolkitContext.init( function onCompleted(){
			camera.projectionMatrix.copy( arToolkitContext.getProjectionMatrix() );
		});

		////////////////////////////////////////////////////////////
		// setup markerRoots
		////////////////////////////////////////////////////////////

		// build markerControls
		markerRoot1 = new THREE.Group();
		scene.add(markerRoot1);
		let markerControls1 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot1, {
			type: 'pattern', patternUrl: "data/pnw.patt",
		})

		let geometry1 = new THREE.PlaneBufferGeometry(1,1, 4,4);
		let loader = new THREE.TextureLoader();
		// let texture = loader.load( 'images/earth.jpg', render );
		let texture = loader.load( img, render );

		let material1 = new THREE.MeshBasicMaterial( { map: texture } );

		mesh1 = new THREE.Mesh( geometry1, material1 );
		mesh1.rotation.x = -Math.PI/2;

		markerRoot1.add( mesh1 );
	}


	function update()
	{
		// update artoolkit on every frame
		if ( arToolkitSource.ready !== false )
			arToolkitContext.update( arToolkitSource.domElement );
	}


	function render()
	{
		renderer.render( scene, camera );
	}


	function animate()
	{
		requestAnimationFrame(animate);
		deltaTime = clock.getDelta();
		totalTime += deltaTime;
		update();
		render();
	}

</script>

</body>
</html>